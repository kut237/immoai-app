<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ImmoAI - Intelligente Immobilienbewertung</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #22d3ee;
            --dark: #0f172a;
            --gray: #64748b;
            --light: #f8fafc;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            animation: slideDown 0.5s ease-out;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            animation: pulse 2s infinite;
        }

        .logo h1 {
            font-size: 28px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .main-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 40px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.15);
            animation: fadeIn 0.7s ease-out;
        }

        .input-section {
            margin-bottom: 40px;
        }

        .input-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: var(--light);
            padding: 5px;
            border-radius: 15px;
        }

        .tab-btn {
            flex: 1;
            padding: 15px 20px;
            border: none;
            background: transparent;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--gray);
        }

        .tab-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 5px 15px rgba(99, 102, 241, 0.2);
        }

        .input-area {
            display: none;
            animation: slideUp 0.4s ease-out;
        }

        .input-area.active {
            display: block;
        }

        .url-input-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .url-input {
            flex: 1;
            padding: 18px 24px;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        .url-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .btn {
            padding: 18px 35px;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(99, 102, 241, 0.4);
        }

        .file-upload-area {
            border: 3px dashed #cbd5e1;
            border-radius: 20px;
            padding: 60px 30px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }

        .file-upload-area:hover {
            border-color: var(--primary);
            background: linear-gradient(135deg, #f0f4ff 0%, #e0e7ff 100%);
        }

        .file-upload-area.dragover {
            border-color: var(--secondary);
            background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
            animation: float 3s ease-in-out infinite;
        }

        .results-section {
            display: none;
            margin-top: 40px;
            animation: fadeIn 0.5s ease-out;
        }

        .results-section.active {
            display: block;
        }

        .property-card {
            background: linear-gradient(135deg, #f8fafc 0%, white 100%);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid #e2e8f0;
            animation: slideUp 0.5s ease-out;
        }

        .property-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 25px;
        }

        .property-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 8px;
        }

        .property-address {
            color: var(--gray);
            font-size: 16px;
        }

        .value-badge {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 20px;
            font-weight: 700;
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
            animation: pulse 2s infinite;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .metric-label {
            color: var(--gray);
            font-size: 14px;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark);
        }

        .ai-analysis {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-top: 30px;
            box-shadow: 0 20px 40px rgba(99, 102, 241, 0.3);
        }

        .ai-analysis h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .ai-analysis p {
            line-height: 1.6;
            opacity: 0.95;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            height: 300px;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container { padding: 15px; }
            .main-card { padding: 25px; }
            .url-input-group { flex-direction: column; }
            .metrics-grid { grid-template-columns: 1fr; }
            .property-header { flex-direction: column; gap: 15px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <div class="logo-icon">🏠</div>
                <h1>ImmoAI</h1>
            </div>
        </div>

        <div class="main-card">
            <div class="input-section">
                <div class="input-tabs">
                    <button class="tab-btn active" onclick="switchTab('url')">
                        🔗 URL eingeben
                    </button>
                    <button class="tab-btn" onclick="switchTab('file')">
                        📄 Exposé hochladen
                    </button>
                </div>

                <div class="input-area active" id="url-tab">
                    <div class="url-input-group">
                        <input type="url" 
                               class="url-input" 
                               id="propertyUrl"
                               placeholder="Immobilien-URL eingeben (z.B. ImmobilienScout24, Immonet)">
                        <button class="btn btn-primary" onclick="analyzeUrl()">
                            <span>🔍</span>
                            <span>Analysieren</span>
                        </button>
                    </div>
                </div>

                <div class="input-area" id="file-tab">
                    <div class="file-upload-area" 
                         id="dropZone"
                         ondrop="handleDrop(event)"
                         ondragover="handleDragOver(event)"
                         ondragleave="handleDragLeave(event)"
                         onclick="document.getElementById('fileInput').click()">
                        <div class="upload-icon">📤</div>
                        <h3>Exposé hier ablegen</h3>
                        <p>oder klicken zum Auswählen</p>
                        <p style="margin-top: 10px; color: var(--gray); font-size: 14px;">
                            PDF, JPG, PNG (max. 10MB)
                        </p>
                        <input type="file" 
                               id="fileInput" 
                               style="display: none;" 
                               accept=".pdf,.jpg,.jpeg,.png"
                               onchange="handleFileSelect(event)">
                    </div>
                </div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <h3>KI analysiert Immobilie...</h3>
                <p style="color: var(--gray); margin-top: 10px;">Dies kann einen Moment dauern</p>
            </div>

            <div class="results-section" id="results">
                <div class="property-card">
                    <div class="property-header">
                        <div>
                            <h2 class="property-title" id="propertyTitle">Moderne 3-Zimmer Wohnung</h2>
                            <p class="property-address" id="propertyAddress">Maxvorstadt, München</p>
                        </div>
                        <div class="value-badge" id="estimatedValue">
                            €750.000
                        </div>
                    </div>

                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">Wohnfläche</div>
                            <div class="metric-value" id="livingSpace">85 m²</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Zimmer</div>
                            <div class="metric-value" id="rooms">3</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Baujahr</div>
                            <div class="metric-value" id="yearBuilt">2018</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Preis/m²</div>
                            <div class="metric-value" id="pricePerSqm">€8.823</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Energieklasse</div>
                            <div class="metric-value" id="energyClass">A+</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Rendite</div>
                            <div class="metric-value" id="yield">3.2%</div>
                        </div>
                    </div>

                    <div class="ai-analysis">
                        <h3>
                            <span>🤖</span>
                            <span>KI-Bewertung</span>
                        </h3>
                        <p id="aiAnalysis">
                            Die Immobilie befindet sich in einer sehr guten Lage mit hervorragender Infrastruktur. 
                            Der Kaufpreis liegt im marktüblichen Bereich. Die moderne Ausstattung und die 
                            energieeffiziente Bauweise sprechen für eine positive Wertentwicklung. 
                            Empfehlung: Kaufenswert bei Eigennutzung, moderate Rendite bei Vermietung.
                        </p>
                    </div>

                    <div class="chart-container">
                        <!-- BREAK-EVEN: Inputs -->
                        <div class="property-card" id="breakeven-card" style="margin-top:20px;">
                        <h3 style="margin-bottom:16px;">💸 Break-Even-Rechnung</h3>

                        <div class="metrics-grid" style="margin-bottom:10px;">
                            <div class="metric-card">
                            <div class="metric-label">Kaufpreis (€)</div>
                            <input id="be-price" type="number" class="url-input" min="0" step="1000" />
                            </div>
                            <div class="metric-card">
                            <div class="metric-label">Eigenkapital (€)</div>
                            <input id="be-equity" type="number" class="url-input" min="0" step="1000" value="0" />
                            </div>
                            <div class="metric-card">
                            <div class="metric-label">Zinssatz p.a. (%)</div>
                            <input id="be-interest" type="text" class="url-input" value="4,5" />
                            </div>
                            <div class="metric-card">
                            <div class="metric-label">Anfängliche Tilgung p.a. (%)</div>
                            <input id="be-redemption" type="text" class="url-input" value="2,0" />
                            </div>
                            <div class="metric-card">
                            <div class="metric-label">Nicht uml. Kosten/Monat (€)</div>
                            <input id="be-nuk" type="number" class="url-input" min="0" step="10" value="100" />
                            </div>
                            <div class="metric-card">
                            <div class="metric-label">Annahme Laufzeit</div>
                            <div class="metric-value">10 Jahre</div>
                            </div>
                        </div>

                        <div class="metric-card" style="margin-bottom:16px;">
                            <div style="display:flex; gap:16px; align-items:center; flex-wrap:wrap;">
                            <label style="font-weight:600;">Mietquelle:</label>
                            <label><input type="radio" name="rent-source" value="listing" checked /> Inseratsmiete</label>
                            <label><input type="radio" name="rent-source" value="mirror" /> Mietspiegel</label>
                            <label><input type="radio" name="rent-source" value="combined" /> Inseratsmiete&nbsp;&amp;&nbsp;Mietspiegel</label>
                            </div>

                            <!-- Inseratsmiete -->
                            <div id="rent-listing-wrap" style="display:flex; gap:10px; align-items:center; margin-top:10px;">
                            <span>Inseratsmiete (kalt) €/Monat (gesamt):</span>
                            <input id="be-rent-listing" type="number" class="url-input" min="0" step="10" value="0" style="max-width:200px;" />
                            </div>

                            <!-- Mietspiegel -->
                            <div id="rent-mirror-wrap" style="display:none; gap:10px; align-items:center; margin-top:10px;">
                            <span>Mietspiegel €/m²/Monat:</span>
                            <input id="be-rent-per-sqm" type="text" class="url-input" value="12,0" style="max-width:120px;" />
                            <span>Wohnfl. (m²):</span>
                            <input id="be-living-space" type="number" class="url-input" min="0" step="1" value="0" style="max-width:120px;" />
                            </div>

                            <!-- Kombiniert -->
                            <div id="rent-combined-wrap" style="display:none; gap:14px; align-items:center; flex-wrap:wrap; margin-top:10px;">
                            <div style="display:flex; gap:10px; align-items:center;">
                                <span>Inseratsmiete €/Monat (Summe):</span>
                                <input id="be-rent-listing-comb" type="number" class="url-input" min="0" step="10" value="0" style="max-width:160px;" />
                            </div>
                            <div style="display:flex; gap:10px; align-items:center;">
                                <span>Mietspiegel €/m²/Monat:</span>
                                <input id="be-rent-per-sqm-comb" type="text" class="url-input" value="12,0" style="max-width:100px;" />
                                <span>m² nach Mietspiegel:</span>
                                <input id="be-sqm-comb" type="number" class="url-input" min="0" step="1" value="0" style="max-width:120px;" />
                            </div>
                            </div>

                            <div style="margin-top:12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                            <button class="btn btn-primary" id="be-calc-btn">Berechnen</button>
                            <span style="color:var(--gray); font-size:14px;">
                                Annuität = Darlehen × (Zins% + anfängliche Tilgung%). Zinsanteil sinkt jährlich, Tilgung steigt – Annuität bleibt konstant.
                            </span>
                            </div>
                        </div>

                        <div class="metrics-grid" style="margin-bottom:10px;">
                            <div class="metric-card">
                            <div class="metric-label">🧮 Monatliche Kreditrate</div>
                            <div class="metric-value" id="be-monthly-rate">€0</div>
                            </div>
                            <div class="metric-card">
                            <div class="metric-label">🏷️ Monatsmiete (netto kalt)</div>
                            <div class="metric-value" id="be-monthly-rent">€0</div>
                            </div>
                            <div class="metric-card">
                            <div class="metric-label">⚖️ Cashflow/Monat (nach nicht uml.)</div>
                            <div class="metric-value" id="be-monthly-cf">€0</div>
                            </div>
                            <div class="metric-card">
                            <div class="metric-label">📍 Break-Even (Jahr)</div>
                            <div class="metric-value" id="be-year">–</div>
                            </div>
                        </div>

                        <div class="chart-container">
                            <canvas id="be-cashflow-chart"></canvas>
                        </div>

                        <div class="property-card" style="margin-top:16px;">
                            <h4 style="margin-bottom:10px;">Tabellarische Übersicht (jährlich; Laufzeit 10 Jahre)</h4>
                            <div style="overflow:auto; max-height:360px; border:1px solid #e2e8f0; border-radius:12px;">
                            <table id="be-table" style="width:100%; border-collapse:collapse;">
                                <thead style="position:sticky; top:0; background:#fff;">
                                <tr>
                                    <th style="padding:10px; border-bottom:1px solid #e2e8f0;">Jahr</th>
                                    <th style="padding:10px; border-bottom:1px solid #e2e8f0;">Restschuld (Jahresanfang)</th>
                                    <th style="padding:10px; border-bottom:1px solid #e2e8f0;">Zinsanteil</th>
                                    <th style="padding:10px; border-bottom:1px solid #e2e8f0;">Tilgungsanteil</th>
                                    <th style="padding:10px; border-bottom:1px solid #e2e8f0;">Annuität (Jahr)</th>
                                    <th style="padding:10px; border-bottom:1px solid #e2e8f0;">Miete (Jahr)</th>
                                    <th style="padding:10px; border-bottom:1px solid #e2e8f0;">Nicht uml. Kosten (Jahr)</th>
                                    <th style="padding:10px; border-bottom:1px solid #e2e8f0;">Cashflow (Jahr)</th>
                                    <th style="padding:10px; border-bottom:1px solid #e2e8f0;">Kumul. Cashflow</th>
                                </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                            </div>
                        </div>
                        </div>
                        <!-- ENDE BREAK-EVEN -->
                        <canvas id="priceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        // Tab-Switching
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.input-area').forEach(area => area.classList.remove('active'));
            
            if (tab === 'url') {
                document.querySelectorAll('.tab-btn')[0].classList.add('active');
                document.getElementById('url-tab').classList.add('active');
            } else {
                document.querySelectorAll('.tab-btn')[1].classList.add('active');
                document.getElementById('file-tab').classList.add('active');
            }
        }

        // URL-Analyse
        async function analyzeUrl() {
            const url = document.getElementById('propertyUrl').value;
            if (!url) {
                alert('Bitte geben Sie eine URL ein');
                return;
            }

            showLoading();
            
            try {
                const response = await fetch('http://localhost:3001/api/analyze-url', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url })
                });

                const data = await response.json();
                displayResults(data);
            } catch (error) {
                console.error('Fehler:', error);
                alert('Fehler bei der Analyse. Bitte versuchen Sie es erneut.');
            } finally {
                hideLoading();
            }
        }

        // File Upload Handling
        function handleDragOver(e) {
            e.preventDefault();
            document.getElementById('dropZone').classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            document.getElementById('dropZone').classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            document.getElementById('dropZone').classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                uploadFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                uploadFile(file);
            }
        }

        async function uploadFile(file) {
            if (file.size > 10 * 1024 * 1024) {
                alert('Datei ist zu groß (max. 10MB)');
                return;
            }

            showLoading();
            
            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('http://localhost:3001/api/analyze-file', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                displayResults(data);
            } catch (error) {
                console.error('Fehler:', error);
                alert('Fehler beim Upload. Bitte versuchen Sie es erneut.');
            } finally {
                hideLoading();
            }
        }

        // Display Results
        function displayResults(data) {
            document.getElementById('propertyTitle').textContent = data.title || 'Immobilie';
            document.getElementById('propertyAddress').textContent = data.address || 'Standort';
            document.getElementById('estimatedValue').textContent = `€${(data.estimatedValue || 0).toLocaleString('de-DE')}`;
            document.getElementById('livingSpace').textContent = `${data.livingSpace || 0} m²`;
            document.getElementById('rooms').textContent = data.rooms || '-';
            document.getElementById('yearBuilt').textContent = data.yearBuilt || '-';
            document.getElementById('pricePerSqm').textContent = `€${(data.pricePerSqm || 0).toLocaleString('de-DE')}`;
            document.getElementById('energyClass').textContent = data.energyClass || '-';
            document.getElementById('yield').textContent = `${data.yield || 0}%`;
            document.getElementById('aiAnalysis').textContent = data.aiAnalysis || 'Keine Analyse verfügbar';

            document.getElementById('results').classList.add('active');
            
            // Chart erstellen
            createPriceChart(data);
        }

        function createPriceChart(data) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (window.priceChartInstance) {
                window.priceChartInstance.destroy();
            }
            
            window.priceChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['2020', '2021', '2022', '2023', '2024'],
                    datasets: [{
                        label: 'Preisentwicklung',
                        data: data.priceHistory || [650000, 680000, 720000, 740000, 750000],
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Geschätzte Preisentwicklung',
                            font: {
                                size: 16,
                                weight: '600'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return '€' + value.toLocaleString('de-DE');
                                }
                            }
                        }
                    }
                }
            });
        }

        function showLoading() {
            document.getElementById('loading').classList.add('active');
            document.getElementById('results').classList.remove('active');
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('active');
        }

        // Demo-Daten für Entwicklung (später entfernen)
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            console.log('Demo-Modus aktiv - Nutze Beispieldaten für Tests');
        }
    </script>
    <script>
    /* ===== Break-Even Rechner v2 (10 Jahre, kombinierte Miete) ===== */

    let beChart;
    const TERM_YEARS = 10;

    // robustes Parsing (Akzeptiert "3,5" und "3.5")
    const parsePct = (v) => {
    if (v == null) return 0;
    const s = String(v).trim().replace('%','').replace('.','').replace(',','.');
    // Sonderfall: "3,5" -> "35"? Wir haben oben "." bereits entfernt, also besser:
    // Alternative: erst Komma -> Punkt, dann NICHT die Punkte entfernen, sondern nur Tausender:
    // Aber Input ist kurz, daher:
    const n = Number(s);
    return isNaN(n) ? 0 : n;
    };
    const parseNum = (v) => {
    if (v == null) return 0;
    const s = String(v).trim().replace(/\./g,'').replace(',','.');
    const n = Number(s);
    return isNaN(n) ? 0 : n;
    };
    const byId = (id) => document.getElementById(id);
    const fmtEUR = (n) => '€' + (Math.round(n).toLocaleString('de-DE'));

    // Umschalten Mietquelle
    document.addEventListener('change', (e) => {
    if (e.target.name === 'rent-source') {
        const val = e.target.value;
        byId('rent-listing-wrap').style.display  = (val === 'listing')   ? 'flex' : 'none';
        byId('rent-mirror-wrap').style.display   = (val === 'mirror')    ? 'flex' : 'none';
        byId('rent-combined-wrap').style.display = (val === 'combined')  ? 'flex' : 'none';
    }
    });

    byId('be-calc-btn').addEventListener('click', runBreakEven);

    function buildSchedule({ loan, interestPct, redeemPct, startMonthlyRent, monthlyNonAlloc }) {
    const i = interestPct / 100;
    const t = redeemPct / 100;
    const annYear = loan * (i + t);     // konstant p.a.
    const annMonth = annYear / 12;

    let rest = loan;
    const rows = [];
    let cumCF = 0;
    let beYear = null;

    for (let y = 1; y <= TERM_YEARS; y++) {
        const rentYear = startMonthlyRent * 12;
        const nonAllocYear = monthlyNonAlloc * 12;

        const interestY = rest * i;
        const redemptionY = Math.min(annYear - interestY, rest);
        const endRest = Math.max(rest - redemptionY, 0);

        const cfYear = rentYear - annYear - nonAllocYear;
        cumCF += cfYear;

        if (beYear === null && cfYear >= 0) beYear = y;

        rows.push({
        year: y,
        restStart: rest,
        interestY,
        redemptionY,
        annYear,
        rentYear,
        nonAllocYear,
        cfYear,
        cumCF,
        restEnd: endRest
        });

        rest = endRest;
        if (rest <= 0) break;
    }

    return { rows, annMonth, beYear };
    }

    function currentMonthlyRent() {
    const source = [...document.getElementsByName('rent-source')]
        .find(r => r.checked)?.value || 'listing';

    if (source === 'listing') {
        return parseNum(byId('be-rent-listing').value);
    }
    if (source === 'mirror') {
        const perSqm = parseNum(byId('be-rent-per-sqm').value);
        const sqm    = parseNum(byId('be-living-space').value);
        return perSqm * sqm;
    }
    // combined
    const listing = parseNum(byId('be-rent-listing-comb').value);
    const perSqmC = parseNum(byId('be-rent-per-sqm-comb').value);
    const sqmC    = parseNum(byId('be-sqm-comb').value);
    return listing + perSqmC * sqmC;
    }

    function runBreakEven() {
    const price   = parseNum(byId('be-price').value);
    const equity  = parseNum(byId('be-equity').value);
    const loan    = Math.max(price - equity, 0);

    const interestPct = parsePct(byId('be-interest').value);
    const redeemPct   = parsePct(byId('be-redemption').value);
    const monthlyNonAlloc = parseNum(byId('be-nuk').value);

    const monthlyRent = currentMonthlyRent();

    if (loan <= 0) {
        alert('Bitte Kaufpreis und Eigenkapital so setzen, dass ein Darlehen > 0 entsteht.');
        return;
    }

    const { rows, annMonth, beYear } = buildSchedule({
        loan, interestPct, redeemPct,
        startMonthlyRent: monthlyRent,
        monthlyNonAlloc
    });

    const monthlyCF = monthlyRent - annMonth - monthlyNonAlloc;

    byId('be-monthly-rate').textContent = fmtEUR(annMonth);
    byId('be-monthly-rent').textContent = fmtEUR(monthlyRent);
    byId('be-monthly-cf').textContent   = fmtEUR(monthlyCF);
    byId('be-year').textContent         = beYear ? beYear : '–';

    renderTable(rows);
    renderCFChart(rows);
    }

    function renderTable(rows) {
    const tbody = document.querySelector('#be-table tbody');
    tbody.innerHTML = '';
    rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
        <td>${r.year}</td>
        <td>${fmtEUR(r.restStart)}</td>
        <td>${fmtEUR(r.interestY)}</td>
        <td>${fmtEUR(r.redemptionY)}</td>
        <td>${fmtEUR(r.annYear)}</td>
        <td>${fmtEUR(r.rentYear)}</td>
        <td>${fmtEUR(r.nonAllocYear)}</td>
        <td style="color:${r.cfYear>=0?'#059669':'#ef4444'}">${fmtEUR(r.cfYear)}</td>
        <td>${fmtEUR(r.cumCF)}</td>
        `;
        tbody.appendChild(tr);
    });
    }

    function renderCFChart(rows) {
    const ctx = document.getElementById('be-cashflow-chart').getContext('2d');
    if (beChart) beChart.destroy();

    beChart = new Chart(ctx, {
        type: 'line',
        data: {
        labels: rows.map(r => `J${r.year}`),
        datasets: [{
            label: 'Cashflow / Jahr',
            data: rows.map(r => Math.round(r.cfYear)),
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.15)',
            tension: 0.35,
            fill: true
        }]
        },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false },
            title: { display: true, text: 'Cashflow-Entwicklung (10 Jahre)' }
        },
        scales: {
            y: { ticks: { callback: (v) => '€' + Number(v).toLocaleString('de-DE') } }
        }
        }
    });
    }

    /* Prefill aus Analyse-Ergebnis */
    function prefillBreakEven(data) {
    const price = data.estimatedValue || 0;
    const sqm = Number((data.livingSpace || '0').toString().replace(',','.')) || 0;

    byId('be-price').value = Math.round(price);
    byId('be-living-space').value = Math.round(sqm);

    // Schätzung aus yield (falls vorhanden)
    const yieldPct = parsePct(data.yield);
    const guessedMonthlyRent = yieldPct > 0 ? (price * (yieldPct/100)) / 12 : 0;
    byId('be-rent-listing').value = Math.round(guessedMonthlyRent);

    runBreakEven();
    }

    /* Hook in bestehende displayResults */
    const _origDisplayResults = displayResults;
    displayResults = function(data){
    _origDisplayResults(data);
    prefillBreakEven(data);
    };
    </script>

    <style> 
        #be-table td, #be-table th { font-size:14px; text-align:right; padding:10px; }
        #be-table td:first-child, #be-table th:first-child { text-align:left; }
        #be-table tbody tr:nth-child(even){ background:#f9fafb; }
        .metrics-grid input {
            width: 100;
        }
    </style>
</body>
</html>